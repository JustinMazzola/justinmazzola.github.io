<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="../util/messagingUtil.js"></script>
    <script type="text/javascript" src="../thirdPartyHelpers/google.js"></script>

    <style>
		html {
			overflow: hidden;
		}
        html, body, #chart_div {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #chart_div {
            position: relative;
        }
    </style>

    <script>
        "use strict";

		va.messagingUtil.setOnDataReceivedCallback(onDataReceived);

		var resultName = null;
		var dataTable = null;
		var selections = null;
		var bar = null;
		var options = {
			chartArea: {
				left: 150,
				bottom: 80,  
				width: '100%',
				height: '100%'  
			},
			legend: {
				position: 'bottom'
			}
		};
		
        google.charts.load('upcoming', {'packages':['corechart']});
        google.charts.setOnLoadCallback(onChartLoad);
		
		va.googleHelper.setupResizeListeners(drawChart);
		
        function onChartLoad() 
		{
            bar = new google.visualization.BarChart(document.getElementById('chart_div'));
			google.visualization.events.addListener(bar, 'ready', readyHandler);
			google.visualization.events.addListener(bar, 'select', selectHandler);
			
			drawChart();
        };
		
		function drawChart()
		{
			if (bar)
				bar.draw(dataTable, options);
		}

        function onDataReceived(resultData)
        {
            if (resultData) 
			{
				resultName = resultData.resultName;
                dataTable = createDataTable(resultData);
				va.googleHelper.formatData(dataTable, resultData);
				selections = va.googleHelper.initializeSelections(dataTable, resultData);
            }

			drawChart();
        }

		function readyHandler(e) 
		{
			if (selections && selections.length > 0)
			{
				bar.setSelection(selections);
			}
		}

		function selectHandler(e) 
		{
			var selection = bar.getSelection();
			va.messagingUtil.postSelectionMessage(resultName, selection);
		}
		
		function createDataTable(resultData) {
                var arrayData;
                if (resultData.data) {
                    arrayData = resultData.data;
                    if (resultData.columns) {
                        arrayData.splice(0, 0, resultData.columns);
                    }
                }
                return google.visualization.arrayToDataTable(arrayData);
            }

    </script>
</head>
<body>
    <div id="chart_div"/>
</body>
</html>